<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Understanding Low-Level Publications in Meteor</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="A series of musings on things, both tangible and intangible.  Long on potential, short on regularity and coherence.">
    <link rel="canonical" href="/meteor/2014/08/01/meteor-low-level-publications.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/pygments.css">
</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="">Neuron Mint Garden</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/about/">About</a>
        
          <a class="page-link" href="/feed.xml"></a>
        
          <a class="page-link" href="/index.html"></a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Understanding Low-Level Publications in Meteor</h1>
    <p class="meta">Aug 1, 2014</p>
  </header>

  <article class="post-content">
  <h2 id="motivation">Motivation</h2>

<p>As increasing numbers of developers are discovering, <a href="https://www.meteor.com/">Meteor</a> is an incredibly powerful, feature-rich platform with which to develop web apps.  By obviating many of the traditional frustrations in rolling out a production app, like authentication and synchronisation of data on client and server, Meteor makes it remarkably easy to progress from idea to prototype to fully-functional product.  However, the developer can become dazzled by such power, and there’s the danger that he or she can end up producing complex, multi-page applications without fully understanding one of the most fundamental components of the platform - the Pub/Sub framework.  This is certainly an accurate description of my personal history with Meteor, and a situation I have very recently put right.</p>

<h2 id="meteorpublish">Meteor.publish</h2>

<p>The first remark I should make is that the canonical demonstration of Meteor’s low-level publish API not only exists, but it’s almost the first thing to appear in the official documentation.  I can only assume that this is part of the problem - the <code>counts-by-room</code> example is relatively subtle and benefits from some understanding of <a href="https://github.com/meteor/meteor/blob/master/packages/livedata/DDP.md">DDP</a> (the protocol developed by Meteor specifically for client-server communication) - which will probably leave many readers skipping over it on their first visit in their enthusiasm to get to the shiny stuff.  Which, it turns out, is a mistake, at least judging by the number of recent questions on SO which can be resolved with a good understanding of this example.</p>

<h4 id="two-publication-patterns-within-a-single-method">Two Publication Patterns within a single Method</h4>

<p>Anybody who has some familiarity with Meteor will be aware of the first of the available publication patterns, in which the publish function uses the familiar collection API to return a collection cursor.  Those with knowledge of <a href="https://github.com/meteor/meteor/blob/master/packages/livedata/DDP.md">DDP</a> will also be aware that the cursor object itself cannot actually be communicated via this protocol, so returning a cursor is really a way of describing the documents (current and future) which the app designer wants to make available on the client.  Meteor’s internals then take care of the actual transmission of these objects via <a href="https://github.com/meteor/meteor/blob/master/packages/livedata/DDP.md">DDP</a>, as well as continuing to observe the cursor for changes and sending the <code>ready</code> message after initial transmission, which is used by the <code>onReady</code> callback and <code>ready</code> methods on the client side, and further utilised in iron-router’s <code>wait</code> method and <code>waitOn</code> hooks.</p>

<p>Here’s the basic setup to which I’ll be referring, which involves a test collection being populated with a random integer in the range [0, 1000) every ten seconds.  There’s also an example of the familiar cursor-based pub-sub pattern:</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">TestData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;testdata&#39;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">isServer</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;cursorPub&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">TestData</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">filter</span> <span class="o">||</span> <span class="p">{});</span>
  <span class="p">});</span>

  <span class="nx">Meteor</span><span class="p">.</span><span class="nx">startup</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="nx">Meteor</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">TestData</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">number</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)});</span>
    <span class="p">},</span> <span class="mi">10000</span><span class="p">);</span>

  <span class="p">});</span>

<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">Meteor</span><span class="p">.</span><span class="nx">isClient</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">Session</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="p">{});</span>

  <span class="nx">Deps</span><span class="p">.</span><span class="nx">autorun</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mySub</span> <span class="o">=</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;cursorPub&#39;</span><span class="p">,</span> <span class="nx">Session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">));</span>
  <span class="p">});</span>

<span class="p">}</span></code></pre></div>

<p>Note that the subscription on the client side is contained within a <code>Deps.autorun</code> block and depends on a reactive <code>Session</code> variable.  This means that we can change the subscription filter simply by changing the value of the session variable, and Meteor is clever enough to manage the resubscription (including doing nothing if the filter hasn’t actually changed).</p>

<p>We can use the Websockets filter in the Network inspector within Chrome Dev Tools to see exactly how this pub/sub example translates into <a href="https://github.com/meteor/meteor/blob/master/packages/livedata/DDP.md">DDP</a> messages sent and received by the client:</p>

<p><img src="/assets/cursorwebsockets.jpg" alt="Cursor pattern publication websockets screenshot" /></p>

<p>Reading from the bottom up, and ignoring messages relating to the <code>meteor_autoupdate_clientVersions</code> subscription, which is a meteor internal, we can see the following:</p>

<ol>
  <li>A <code>connect</code> message sent by the client to the server.</li>
  <li>A <code>subscribe</code> message for the <code>cursorPub</code> publication, coming from the client, with an attached subscription id.</li>
  <li>The <code>connected</code> message returned by the server.</li>
  <li>Two <code>added</code> messages returned with a <code>collection</code> field of <code>testdata</code> so that the client knows where to store these documents, and the (in this case rather limited) document contents.</li>
  <li>A <code>ready</code> message sent by the server indicating that initial data on this subscription has all been sent - note that the <code>subs</code> field has the same id as the <code>subscribe</code> message which was sent by the client in step (2).</li>
  <li>A further <code>added</code> message as the <code>setInterval</code> block on the server runs again and adds a new document to the collection.  Meteor is automatically observing the cursor which was returned by the <code>Meteor.publish</code> block and sending any changes to subscribing clients.  Note that the timestamp on this message is several seconds after the others, confirming that this was a document added after the connection had been made and the initial data synchronised.</li>
</ol>

<h4 id="distributed-data-protocol">Distributed Data Protocol</h4>

<p>The second way to use the Pub/Sub model is really just an API to exactly this <a href="https://github.com/meteor/meteor/blob/master/packages/livedata/DDP.md">DDP</a> flow from the server side, relating to a specific connection and subscription request.  What this means is that the <code>name</code>d publication function will be run once for each incoming subscription on that <code>name</code>, but rather than returning a cursor and leaving it for Meteor to generate the required <a href="https://github.com/meteor/meteor/blob/master/packages/livedata/DDP.md">DDP</a> messages, it allows us to send customised <a href="https://github.com/meteor/meteor/blob/master/packages/livedata/DDP.md">DDP</a> messages to suit the requirements of the application.  Here’s an example which does exactly the same as the one above:</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;ddpPub&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">subHandle</span> <span class="o">=</span> <span class="nx">TestData</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">filter</span> <span class="o">||</span> <span class="p">{}).</span><span class="nx">observeChanges</span><span class="p">({</span>
    <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">changed</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">changed</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">removed</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">removed</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">onStop</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">subHandle</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">});</span></code></pre></div>

<p>So what exactly are we doing here?</p>

<ol>
  <li>Storing a reference to the publish function’s context in <code>self</code>, as we’ll need to use it inside the functions contained within <code>observeChanges</code>, where the value of <code>this</code> will be different.</li>
  <li>Setting up an observer to monitor the <code>TestData</code> collection (appropriately filtered).  In this simple example, we are simply passing any changes to the returned document set on the server (i.e. when documents are <code>added</code>, <code>changed</code> or <code>removed</code>) to the subscribing client verbatim, by instructing the publish function to send an appropriate <a href="https://github.com/meteor/meteor/blob/master/packages/livedata/DDP.md">DDP</a> message with exactly the same details down to the client.  This is what the <code>self.added</code>, <code>self.changed</code> and <code>self.removed</code> calls are doing.</li>
  <li>Note that these functions will run immediately in a synchronous manner for that specific subscriber, so all the existing documents will fire the <code>added</code> hook before any further processing is done.</li>
  <li>Thus, by the time we reach <code>self.ready()</code> we can be confident that all the existing documents have already been sent with <code>self.added</code> calls, and it’s safe to tell the client that their subscription is ready to use.  It’s very important that we make this call at some stage, otherwise anything that hooks into the subscription’s <code>ready</code> method will never be fired.</li>
  <li>Finally, we have to make sure we <code>stop</code> the observer when the subscription is closed (at which point the <code>onStop</code> callback is fired).  If we don’t do this then the server will continue to observe the document set until it is restarted, even with no subscriber to send changes to, and server resource utilisation will increase inexorably as clients connect and reconnect.  This would not be a good outcome!</li>
</ol>

<p>When we inspect the result in Chrome Dev Tools, the result is uncannily similar:</p>

<p><img src="/assets/ddpwebsockets.jpg" alt="DDP pattern publication websockets screenshot" /></p>

<h2 id="something-rather-more-useful">Something Rather More Useful</h2>

<p>At this stage, it would be reasonable to ask what the point of all this was, since we’ve just recreated exactly the same series of messages using significantly more code.  But the fact that we now have a way of intermediating the conversation between client and server databases gives us a huge amount of power.  This is utilised very cleverly in the <a href="http://docs.meteor.com/#meteor_publish"><code>counts-by-room</code> example</a> provided within the Meteor docs, but I’m going to take a slightly different tack.</p>

<h3 id="existing-documents-versus-new-additions">Existing Documents versus New Additions</h3>

<p>One question which is regularly asked on Stack Overflow and elsewhere relates to how the client can be sure it’s local collection has been fully synchronised before attempting to work with it.  I would argue that the majority of cases can be resolved with sensible use of the <code>ready()</code> method, which is reactive and triggered by the DDP <code>ready</code> method we’ve seen above.  However, whilst I am no expert on websockets and stand to be corrected, I am certain that there are cases in which the order in which messages are sent from the server isn’t necessarily the same as the order in which they’re received by the client, at least if there is a degree of latency involved.  What this means is that the <code>ready</code> message would arrive before one or more documents.  Perhaps this is no problem, as Meteor’s built-in reactivity will re-render everything as soon as the missing documents arrive and the client will barely even notice.  But what if even that outcome is unacceptable?</p>

<h4 id="pattern-1-a-document-counter">Pattern 1: A Document Counter</h4>

<p>One way of confirming that the original document set had arrived intact would be to send the number of documents <code>added</code> before the <code>ready</code> call as an additional document itself.  This would best be done using another collection to avoid the need to filter it out of the data set that you’re actually interested in communicating.</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">CollectionCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span><span class="p">(</span><span class="s1">&#39;collectioncount&#39;</span><span class="p">);</span> <span class="c1">// NOTE THAT THIS ONLY NEEDS TO BE DECLARED ON THE CLIENT</span>

<span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;ddpPub&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// WHILST THIS IS OBVIOUSLY ON THE SERVER</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">subHandle</span> <span class="o">=</span> <span class="nx">TestData</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">filter</span> <span class="o">||</span> <span class="p">{}).</span><span class="nx">observeChanges</span><span class="p">({</span>
    <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ready</span><span class="p">)</span>
        <span class="nx">count</span> <span class="o">++</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">changed</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">changed</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">removed</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">removed</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s2">&quot;collectioncount&quot;</span><span class="p">,</span> <span class="nx">Random</span><span class="p">.</span><span class="nx">id</span><span class="p">(),</span> <span class="p">{</span><span class="nx">Collection</span><span class="o">:</span> <span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">Count</span><span class="o">:</span> <span class="nx">count</span><span class="p">});</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>

  <span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">onStop</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">subHandle</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">});</span></code></pre></div>

<p>This publish function will also populate the <code>CollectionCount</code> collection (which only needs to be constructed on the client) with an object that contains the number of documents in the existing set.  You can then delay mission critical logic on the client until <code>TestData.find().count() === CollectionCount.findOne({Collection: "testdata"}).Count</code>.  Note that the actual logic will need to be slightly longer to account for the period in which <code>CollectionCount.findOne({Collection: "testdata"})</code> returns nothing as the publish function hasn’t yet sent the corresponding message.</p>

<h4 id="pattern-2-an-additional-field">Pattern 2: An Additional Field</h4>

<p>A similar scenario is one in which we don’t need to know the exact number of documents in the collection when we subscribe, but we do need to know which they are.  This can be solved as follows:</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;ddpPub&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">subHandle</span> <span class="o">=</span> <span class="nx">TestData</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">filter</span> <span class="o">||</span> <span class="p">{}).</span><span class="nx">observeChanges</span><span class="p">({</span>
    <span class="nx">added</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ready</span><span class="p">)</span>
        <span class="nx">fields</span><span class="p">.</span><span class="nx">existing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">added</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">changed</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">changed</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">fields</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">removed</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">removed</span><span class="p">(</span><span class="s2">&quot;testdata&quot;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">ready</span><span class="p">();</span>

  <span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">onStop</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">subHandle</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">});</span></code></pre></div>

<p>Now if we query the collection on the client immediately after we’ve received the <code>ready</code> message, we will notice that <code>TestData.find().count</code> is equal to <code>TestData.find({existing: true}).count()</code>.  However, once additional documents are added on the client side, this will cease to be the case as these will no longer have the <code>existing</code> property, allowing us to identify that these are genuinely newly-added documents from a global perspective.</p>

<p>The two examples above could be combined to solve a problem in which data was being rapidly generated and the client needed to be sure that, not only did it have the right number of documents, but those were exactly the documents in the existing set.  Alternatively, in some use cases, we might not want to send the existing documents over the wire at all, in which case we would simply not execute the <code>self.added</code> call if <code>!ready</code> evaluated to true.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Hopefully, this has shed some light on the power and flexibility of the low-level Publications API, which I believe is frequently ignored by Meteor enthusiasts who may have grown too accustomed to the convenience of the higher-level cursor-based API.  I’m sure there are hundreds of interesting and more elaborate use-cases, involving selective updates, periodic removals, record extension with myriad extra data and so on, and I look forward to seeing them.</p>

<h2 id="a-note-on-subscriptions">A Note on Subscriptions</h2>

<p>Finally, as I pointed out earlier, I have chosen to put my subscription inside a <code>Deps.autorun</code> block on the client side, to allow automatic resubscription when the filter is amended.  This provides other benefits from a reactivity perspective:</p>

<ul>
  <li>If you have a Template helper which has a dependency on the readiness of a subscription, this allows you to resubscribe and maintain reactivity.  What this means is that <code>mySub.ready()</code> in the example above will always reactively supply the state of the current subscription, even though the actual subscription object has been stopped and replaced by a new one.  This is very convenient!</li>
  <li>In contrast, if you <em>don’t</em> put your subscription in a <code>Deps.autorun</code> block like this, your reactivity can break when you resubscribe.  This means that if you were using <code>mySub.ready()</code> in a helper function (or another reactive context) and then resubscribe with <code>mySub = Meteor.subscribe('testdata', newFilter);</code> your helper will not rerun.  For this reason I would always recommend putting your subscriptions in <code>Deps.autorun</code> blocks and having them update by changing the value of Session variables, or another reactive data source.</li>
  <li>By default, a subscription that runs within a <code>Deps.autorun</code> will not actually resubscribe if there is no effective change in the subscription request, even if the <code>autorun</code> block is rerun.  I can’t imagine a scenario in which this behaviour would be undesirable, but if that’s ever the case you could force a resubscription by just including <code>mySub.stop()</code> before the <code>Meteor.subscribe</code> line in the <code>autorun</code> block.</li>
</ul>


  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Neuron Mint Garden</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>Try not to panic if this is interesting</li>
        <li><a href="mailto:silverton.richard@googlemail.com">silverton.richard@googlemail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">A series of musings on things, both tangible and intangible.  Long on potential, short on regularity and coherence.</p>
    </div>

  </div>

</footer>


    </body>
</html>